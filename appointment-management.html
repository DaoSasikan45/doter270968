<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ - Glaucoma Care System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .header-title p {
            font-size: 16px;
            color: #7f8c8d;
        }

        .back-btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #3498db;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-card:nth-child(2) { border-left-color: #e74c3c; }
        .stat-card:nth-child(3) { border-left-color: #27ae60; }
        .stat-card:nth-child(4) { border-left-color: #f39c12; }

        .stat-number {
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .stat-card:nth-child(2) .stat-number { color: #e74c3c; }
        .stat-card:nth-child(3) .stat-number { color: #27ae60; }
        .stat-card:nth-child(4) .stat-number { color: #f39c12; }

        .stat-label {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
        }

        /* Controls */
        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-select {
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Appointments List */
        .appointments-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f3f4;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .appointments-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .appointment-card {
            border: 2px solid #f1f3f4;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .appointment-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .patient-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .patient-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 24px;
        }

        .patient-details h4 {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .patient-details p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .appointment-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-scheduled { background: #e3f2fd; color: #1976d2; }
        .status-confirmed { background: #e8f5e8; color: #2e7d32; }
        .status-completed { background: #f3e5f5; color: #7b1fa2; }
        .status-cancelled { background: #ffebee; color: #c62828; }
        .status-rescheduled { background: #fff3e0; color: #f57c00; }

        .appointment-details {
            margin-bottom: 20px;
        }

        .appointment-datetime {
            display: flex;
            gap: 30px;
            margin-bottom: 15px;
        }

        .datetime-item {
            color: #5f6368;
            font-size: 16px;
            font-weight: 500;
        }

        .appointment-type {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            color: #5f6368;
            font-size: 15px;
            font-weight: 500;
            display: inline-block;
        }

        .appointment-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #fff3e0;
            color: #f57c00;
        }

        .btn-confirm {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .btn-cancel {
            background: #ffebee;
            color: #c62828;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            filter: brightness(110%);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f3f4;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #bdc3c7;
            cursor: pointer;
            padding: 5px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Loading and Empty States */
        .loading, .empty-state, .error-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .loading {
            font-size: 18px;
        }

        .empty-state {
            font-size: 16px;
        }

        .error-state {
            color: #e74c3c;
            font-size: 16px;
        }

        /* Success notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .controls-top {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
            }

            .filter-group {
                justify-content: center;
                flex-wrap: wrap;
            }

            .appointment-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .appointment-datetime {
                flex-direction: column;
                gap: 10px;
            }

            .appointment-actions {
                justify-content: center;
                flex-wrap: wrap;
            }

            .modal-content {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h1>
                    <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</p>
                </div>
                <a href="dashboard.html" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalAppointments">0</div>
                <div class="stat-label">‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayAppointments">0</div>
                <div class="stat-label">‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="confirmedAppointments">0</div>
                <div class="stat-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingAppointments">0</div>
                <div class="stat-label">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-top">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ HN...">
                </div>
                <div class="filter-group">
                    <select class="filter-select" id="statusFilter">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                        <option value="scheduled">‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="confirmed">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                        <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                        <option value="rescheduled">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</option>
                    </select>
                    <select class="filter-select" id="dateFilter">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                        <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                        <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                    </select>
                    <button class="add-btn" onclick="openModal()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </div>
        </div>

        <!-- Appointments Section -->
        <div class="appointments-section">
            <div class="section-header">
                <h2 class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
            </div>
            <div class="appointments-list" id="appointmentsList">
                <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢...</div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="appointmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</h3>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <form id="appointmentForm">
                <div class="form-group">
                    <label class="form-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                    <select class="form-select" id="patientSelect" required>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                    <input type="date" class="form-input" id="appointmentDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                    <input type="time" class="form-input" id="appointmentTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î</label>
                    <select class="form-select" id="appointmentType" required>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó...</option>
                        <option value="routine_checkup">‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥</option>
                        <option value="follow_up">‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</option>
                        <option value="consultation">‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</option>
                        <option value="emergency">‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
                        <option value="surgery_followup">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea class="form-input" id="appointmentNotes" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                </div>
                <button type="submit" class="submit-btn">
                    <span id="submitBtnText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let appointments = [];
        let patients = [];
        let currentEditId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Appointment Management...');
            loadPatients();
            loadAppointments();
            setupEventListeners();
            setMinDate();
        });

        // API call function
        async function apiCall(endpoint, options = {}) {
            const baseURL = 'http://localhost:3000';
            const token = localStorage.getItem('authToken') || 
              localStorage.getItem('token') || 
              sessionStorage.getItem('authToken') ||
              sessionStorage.getItem('token');

            if (!token) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                window.location.href = 'doctor-login.html';
                return;
            }

            const config = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                ...options
            };

            try {
                const response = await fetch(`${baseURL}${endpoint}`, config);
                
                if (response.status === 401) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                    window.location.href = 'doctor-login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('‚ùå API call failed:', error);
                throw error;
            }
        }

        // Load patients for dropdown
        async function loadPatients() {
            try {
                console.log('üë• Loading patients...');
                const data = await apiCall('/api/patients');
                patients = data || [];
                
                const patientSelect = document.getElementById('patientSelect');
                patientSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢...</option>';
                
                patients.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.patient_id;
                    option.textContent = `${patient.first_name} ${patient.last_name} (HN: ${patient.hn})`;
                    patientSelect.appendChild(option);
                });
                
                console.log(`‚úÖ Loaded ${patients.length} patients`);
            } catch (error) {
                console.error('‚ùå Error loading patients:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ');
            }
        }

        // Load appointments
        async function loadAppointments() {
            try {
                console.log('üìÖ Loading appointments...');
                showLoading();
                const data = await apiCall('/api/appointments');
                appointments = data || [];
                
                renderAppointments();
                updateStatistics();
                
                console.log(`‚úÖ Loaded ${appointments.length} appointments`);
            } catch (error) {
                console.error('‚ùå Error loading appointments:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ');
            }
        }

        // Render appointments
        // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderAppointments() ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå appointment-management.html

        function renderAppointments() {
            const container = document.getElementById('appointmentsList');
            
            if (appointments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
                        <small>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = appointments.map(appointment => {
                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                const firstName = appointment.first_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const lastName = appointment.last_name || '';
                const fullName = `${firstName} ${lastName}`.trim();
                const hn = appointment.hn || appointment.patient_hn || 'N/A';
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                let actionButtons = '';
                
                if (appointment.appointment_status === 'scheduled') {
                    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô - ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    actionButtons = `
                        <button class="action-btn btn-edit" onclick="event.stopPropagation(); editAppointment('${appointment.appointment_id}')">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button class="action-btn btn-confirm" onclick="event.stopPropagation(); confirmAppointment('${appointment.appointment_id}')">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                        </button>
                        <button class="action-btn btn-cancel" onclick="event.stopPropagation(); cancelAppointment('${appointment.appointment_id}')">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    `;
                } else if (appointment.appointment_status === 'confirmed') {
                    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß - ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    actionButtons = `
                        <button class="action-btn btn-edit" onclick="event.stopPropagation(); editAppointment('${appointment.appointment_id}')">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button class="action-btn btn-cancel" onclick="event.stopPropagation(); cancelAppointment('${appointment.appointment_id}')">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    `;
                } else if (appointment.appointment_status === 'completed') {
                    // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π
                    actionButtons = `
                        <button class="action-btn" style="background: #f8f9fa; color: #6c757d;" onclick="event.stopPropagation(); viewAppointmentDetails('${appointment.appointment_id}')">
                            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                    `;
                } else if (appointment.appointment_status === 'cancelled') {
                    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß - ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏£
                    actionButtons = `
                        <button class="action-btn" style="background: #f8f9fa; color: #6c757d;" onclick="event.stopPropagation(); viewAppointmentDetails('${appointment.appointment_id}')">
                            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                    `;
                } else {
                    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ - ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                    actionButtons = `
                        <button class="action-btn btn-edit" onclick="event.stopPropagation(); editAppointment('${appointment.appointment_id}')">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button class="action-btn" style="background: #f8f9fa; color: #6c757d;" onclick="event.stopPropagation(); viewAppointmentDetails('${appointment.appointment_id}')">
                            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                    `;
                }

                return `
                    <div class="appointment-card" onclick="viewAppointmentDetails('${appointment.appointment_id}')">
                        <div class="appointment-header">
                            <div class="patient-info">
                                <div class="patient-avatar">
                                    ${firstName.charAt(0).toUpperCase()}
                                </div>
                                <div class="patient-details">
                                    <h4>${fullName}</h4>
                                    <p>HN: ${hn}</p>
                                </div>
                            </div>
                            <div class="appointment-status status-${appointment.appointment_status}">
                                ${getAppointmentStatusText(appointment.appointment_status)}
                            </div>
                        </div>
                        
                        <div class="appointment-details">
                            <div class="appointment-datetime">
                                <div class="datetime-item">
                                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDate(appointment.appointment_date)}
                                </div>
                                <div class="datetime-item">
                                    ‡πÄ‡∏ß‡∏•‡∏≤: ${appointment.appointment_time}
                                </div>
                            </div>
                            
                            <div class="appointment-type">
                                ${getAppointmentTypeText(appointment.appointment_type)}
                            </div>
                        </div>

                        <div class="appointment-actions">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update statistics
        function updateStatistics() {
            const total = appointments.length;
            const today = new Date().toISOString().split('T')[0];
            const todayCount = appointments.filter(apt => apt.appointment_date === today).length;
            const confirmedCount = appointments.filter(apt => apt.appointment_status === 'confirmed').length;
            const pendingCount = appointments.filter(apt => apt.appointment_status === 'scheduled').length;

            document.getElementById('totalAppointments').textContent = total;
            document.getElementById('todayAppointments').textContent = todayCount;
            document.getElementById('confirmedAppointments').textContent = confirmedCount;
            document.getElementById('pendingAppointments').textContent = pendingCount;
        }

        // Helper functions
        function getAppointmentStatusText(status) {
            const statuses = {
                'scheduled': '‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                'confirmed': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                'rescheduled': '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î',
                'no_show': '‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î'
            };
            return statuses[status] || status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
        }

        function getAppointmentTypeText(type) {
            const types = {
                'routine_checkup': '‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥',
                'follow_up': '‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°',
                'followup': '‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°',
                'consultation': '‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤',
                'emergency': '‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
                'surgery_followup': '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î'
            };
            return types[type] || type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';
        }

        function formatDate(dateString) {
            if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const date = new Date(dateString);
            
            // Handle Buddhist calendar (if year > 2100, convert from BE to CE)
            if (date.getFullYear() > 2100) {
                date.setFullYear(date.getFullYear() - 543);
            }
            
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Modal functions
        function openModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('submitBtnText').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';
            document.getElementById('appointmentForm').reset();
            document.getElementById('appointmentModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('appointmentModal').style.display = 'none';
            currentEditId = null;
        }

        function editAppointment(appointmentId) {
            const appointment = appointments.find(a => a.appointment_id === appointmentId);
            if (!appointment) return;

            currentEditId = appointmentId;
            document.getElementById('modalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';
            document.getElementById('submitBtnText').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            
            document.getElementById('patientSelect').value = appointment.patient_id;
            document.getElementById('appointmentDate').value = appointment.appointment_date;
            document.getElementById('appointmentTime').value = appointment.appointment_time;
            document.getElementById('appointmentType').value = appointment.appointment_type;
            document.getElementById('appointmentNotes').value = appointment.notes || '';
            
            document.getElementById('appointmentModal').style.display = 'flex';
        }

        // Appointment actions
        async function confirmAppointment(appointmentId) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            try {
                await apiCall(`/api/appointments/${appointmentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ appointment_status: 'confirmed' })
                });
                
                showSuccess('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                loadAppointments();
            } catch (error) {
                console.error('‚ùå Error confirming appointment:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ');
            }
        }

        async function cancelAppointment(appointmentId) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            try {
                await apiCall(`/api/appointments/${appointmentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ appointment_status: 'cancelled' })
                });
                
                showSuccess('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                loadAppointments();
            } catch (error) {
                console.error('‚ùå Error cancelling appointment:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ');
            }
        }

        function viewAppointmentDetails(appointmentId) {
            const appointment = appointments.find(a => a.appointment_id === appointmentId);
            if (!appointment) return;
            
            const details = [
                `‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${appointment.first_name} ${appointment.last_name}`,
                `HN: ${appointment.hn || 'N/A'}`,
                `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDate(appointment.appointment_date)}`,
                `‡πÄ‡∏ß‡∏•‡∏≤: ${appointment.appointment_time}`,
                `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${getAppointmentTypeText(appointment.appointment_type)}`,
                `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${getAppointmentStatusText(appointment.appointment_status)}`,
                appointment.notes ? `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${appointment.notes}` : ''
            ].filter(Boolean).join('\n');
            
            alert(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢:\n\n${details}`);
        }

        // Form submission
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                patient_id: document.getElementById('patientSelect').value,
                appointment_date: document.getElementById('appointmentDate').value,
                appointment_time: document.getElementById('appointmentTime').value,
                appointment_type: document.getElementById('appointmentType').value,
                notes: document.getElementById('appointmentNotes').value,
                appointment_status: 'scheduled'
            };

            try {
                if (currentEditId) {
                    await apiCall(`/api/appointments/${currentEditId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    showSuccess('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    await apiCall('/api/appointments', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    showSuccess('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
                
                closeModal();
                loadAppointments();
            } catch (error) {
                console.error('‚ùå Error saving appointment:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ');
            }
        });

        // Event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterAppointments);
            document.getElementById('statusFilter').addEventListener('change', filterAppointments);
            document.getElementById('dateFilter').addEventListener('change', filterAppointments);

            // Close modal when clicking outside
            document.getElementById('appointmentModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // Filter appointments
        function filterAppointments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filteredAppointments = [...appointments];

            // Search filter
            if (searchTerm) {
                filteredAppointments = filteredAppointments.filter(appointment =>
                    appointment.first_name.toLowerCase().includes(searchTerm) ||
                    appointment.last_name.toLowerCase().includes(searchTerm) ||
                    (appointment.hn && appointment.hn.toLowerCase().includes(searchTerm))
                );
            }

            // Status filter
            if (statusFilter) {
                filteredAppointments = filteredAppointments.filter(appointment =>
                    appointment.appointment_status === statusFilter
                );
            }

            // Date filter
            if (dateFilter) {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                filteredAppointments = filteredAppointments.filter(appointment => {
                    const appointmentDate = new Date(appointment.appointment_date);
                    
                    // Handle Buddhist calendar conversion
                    if (appointmentDate.getFullYear() > 2100) {
                        appointmentDate.setFullYear(appointmentDate.getFullYear() - 543);
                    }
                    
                    const appointmentDateStr = appointmentDate.toISOString().split('T')[0];
                    
                    switch (dateFilter) {
                        case 'today':
                            return appointmentDateStr === todayStr;
                        case 'week':
                            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                            return appointmentDate >= today && appointmentDate <= weekFromNow;
                        case 'month':
                            const monthFromNow = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
                            return appointmentDate >= today && appointmentDate <= monthFromNow;
                        default:
                            return true;
                    }
                });
            }

            // Update display with filtered appointments
            const originalAppointments = appointments;
            appointments = filteredAppointments;
            renderAppointments();
            updateStatistics();
            appointments = originalAppointments;
        }

        // Set minimum date for appointment date input
        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').setAttribute('min', today);
        }

        // Utility functions
        function showLoading() {
            document.getElementById('appointmentsList').innerHTML = `
                <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢...</div>
            `;
        }

        function showError(message) {
            document.getElementById('appointmentsList').innerHTML = `
                <div class="error-state">
                    <p>${message}</p>
                    <button onclick="loadAppointments()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            `;
        }

        function showSuccess(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Hide and remove notification
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>